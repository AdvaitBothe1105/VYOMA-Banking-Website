// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id          String   @id @default(uuid())
  crn         String   @unique
  name        String
  email       String
  password    String
  phone       String
  dob         DateTime
  address     String
  city        String
  state       String
  pincode     String
  aadharUrl   String
  panUrl      String
  accountType String
  agree       Boolean
  createdAt   DateTime @default(now())

  onchainAddress      String? // Ethereum address
  encryptedPrivateKey String? // Encrypted private key (AES-256-GCM)
  kycStatus           String?     @default("pending") // pending | verified | rejected
  isAdmin             Boolean     @default(false) // Admin role flag
  accounts            Account[]
  loansBorrowed       Loan[]
  loanVotes           LoanVote[]
  reputation          Reputation?
}

model Account {
  account_id     Int      @id @default(autoincrement())
  crn            String   @unique
  accountType    String
  account_number String   @unique
  ifsc_code      String   @default("VYOMAIN0000001")
  balance        Decimal  @default(3000.00)
  name           String
  created_at     DateTime @default(now())

  user             User          @relation(fields: [crn], references: [crn], onDelete: Cascade)
  transactionsFrom Transaction[] @relation("FromAccount")
  transactionsTo   Transaction[] @relation("ToAccount")
}

model Transaction {
  id            Int      @id @default(autoincrement())
  fromAccountId Int
  toAccountId   Int
  amount        Decimal
  remarks       String?
  createdAt     DateTime @default(now())

  fromAccount    Account @relation("FromAccount", fields: [fromAccountId], references: [account_id])
  toAccount      Account @relation("ToAccount", fields: [toAccountId], references: [account_id])
  blockchainHash String?
}

model ReconciliationLog {
  id            Int      @id @default(autoincrement())
  crn           String
  walletAddress String
  action        String // SYNC_FROM_CHAIN | RE_MINT_DEV | SYNC_DB_FROM_CHAIN | SYNC_CHAIN_FROM_DB
  chainVyo      Decimal
  dbBalance     Decimal
  ethBalance    Decimal
  performedBy   String // admin CRN or email
  createdAt     DateTime @default(now())
}

model Loan {
  id              Int      @id @default(autoincrement())
  borrowerCrn     String
  amount          Decimal
  tenureMonths    Int
  purpose         String
  purposeCategory String   @default("personal") // education | medical | business | personal | other
  interestRate    Decimal
  riskBand        String   // A, B, C
  status          String   // pending | voting | approved | rejected
  createdAt       DateTime @default(now())
  approvedAt      DateTime?
  rejectedAt      DateTime?

  borrower User       @relation(fields: [borrowerCrn], references: [crn])
  votes    LoanVote[]
}

model LoanVote {
  id        Int      @id @default(autoincrement())
  loanId    Int
  voterCrn  String
  vote      String // yes | no | abstain
  weight    Int @default(1)
  createdAt DateTime @default(now())

  loan  Loan @relation(fields: [loanId], references: [id])
  voter User @relation(fields: [voterCrn], references: [crn])

  @@unique([loanId, voterCrn])
}

model Reputation {
  crn       String   @id
  score     Int      @default(300)
  updatedAt DateTime @updatedAt

  user User @relation(fields: [crn], references: [crn])
}
